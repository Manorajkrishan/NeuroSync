<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSync - Emotion-Aware Intelligent System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="multilayer-styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† NeuroSync</h1>
            <p class="subtitle">Emotion-Aware Intelligent System</p>
        </header>

        <div class="main-content">
            <div class="input-section">
                <h2>How are you feeling?</h2>
                
                <!-- Facial Expression Detection Section -->
                <div class="facial-detection-section">
                    <div class="camera-container">
                        <video id="videoElement" autoplay playsinline style="display: none; width: 100%; max-width: 640px; border-radius: 10px;"></video>
                        <canvas id="canvasElement" style="display: none;"></canvas>
                        <div id="cameraPlaceholder" class="camera-placeholder">
                            <p>üì∑ Enable camera for <strong>real-time emotion detection</strong></p>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                                The system will automatically detect your emotions and provide comfort - no typing needed!
                            </p>
                            <button id="startCameraBtn" onclick="startFacialDetection()" class="camera-btn">üì∑ Start Real-Time Detection</button>
                        </div>
                        <div id="facialEmotionDisplay" class="facial-emotion-display" style="display: none;">
                            <div class="facial-emotion-badge" id="facialEmotionBadge"></div>
                            <div class="facial-confidence" id="facialConfidence"></div>
                            <button id="stopCameraBtn" onclick="stopFacialDetection()" class="camera-btn stop-btn">‚èπÔ∏è Stop Camera</button>
                        </div>
                    </div>
                </div>
                
                <textarea id="emotionInput" placeholder="Type how you're feeling... Or ask me to do something! (e.g., 'I'm feeling great!' or 'Play voice note of Sarah' or 'I miss mom')" rows="4"></textarea>
                <div class="input-actions">
                    <button id="detectButton" onclick="detectEmotion()">Detect Emotion</button>
                    <button id="multilayerButton" onclick="toggleMultiLayerInput()" class="multilayer-btn" title="Toggle Multi-Layer Input Section">üéØ Multi-Layer Input</button>
                    <button id="detectMultiLayerButton" onclick="detectMultiLayerEmotion()" class="multilayer-btn" style="display: none;" title="Detect Emotion from Multiple Layers">üéØ Detect Multi-Layer</button>
                    <button id="recordButton" onclick="toggleRecording()" class="record-btn">üé§ Record Voice</button>
                    <button id="ttsToggleBtn" onclick="toggleTTS()" class="tts-toggle-btn" title="Toggle Text-to-Speech">üîá TTS Off</button>
                    <button id="consentButton" onclick="showConsentPanel()" class="consent-btn" title="Privacy & Consent Settings">üîí Consent</button>
                </div>
                <div id="recordingStatus" style="display: none; margin-top: 10px; color: #ef4444;">
                    <span id="recordingIndicator">‚óè</span> Recording... Click again to stop
                </div>
                <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 10px;"></audio>
            </div>

            <div class="voice-notes-section" style="margin-top: 20px;">
                <h3>üé§ Voice Notes</h3>
                <div id="voiceNotesList" class="voice-notes-list"></div>
            </div>
            
            <!-- Consent/Privacy Panel -->
            <div id="consentPanel" class="consent-panel" style="display: none; margin-top: 20px; background: var(--surface); padding: 20px; border-radius: 10px; border: 2px solid var(--primary-color);">
                <h3>üîí Privacy & Consent Settings</h3>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 20px;">
                    Control what data NeuroSync can collect for emotion detection. You can enable/disable specific layers.
                </p>
                <div class="consent-options">
                    <label class="consent-item">
                        <input type="checkbox" id="consentEmotionSensing" onchange="toggleConsent('emotionSensing')">
                        <span>Enable Emotion Sensing (Required)</span>
                    </label>
                    <label class="consent-item">
                        <input type="checkbox" id="consentVisualLayer" onchange="toggleConsent('visualLayer')">
                        <span>Visual Layer (Facial Expression Detection)</span>
                    </label>
                    <label class="consent-item">
                        <input type="checkbox" id="consentAudioLayer" onchange="toggleConsent('audioLayer')">
                        <span>Audio Layer (Voice Analysis)</span>
                    </label>
                    <label class="consent-item">
                        <input type="checkbox" id="consentBiometricLayer" onchange="toggleConsent('biometricLayer')">
                        <span>Biometric Layer (Heart Rate, GSR, Temperature)</span>
                    </label>
                    <label class="consent-item">
                        <input type="checkbox" id="consentDataStorage" onchange="toggleConsent('dataStorage')">
                        <span>Data Storage (Save emotion history)</span>
                    </label>
                </div>
                <button onclick="document.getElementById('consentPanel').style.display='none'" class="close-btn" style="margin-top: 15px;">Close</button>
            </div>

            <!-- Multi-Layer Input Section -->
            <div id="multilayerInputSection" class="multilayer-input-section" style="display: none; margin-top: 20px; background: var(--surface); padding: 20px; border-radius: 10px;">
                <h3>üéØ Multi-Layer Emotion Detection</h3>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 20px;">
                    Provide additional data from different layers for more accurate emotion detection.
                </p>
                
                <!-- Biometric Inputs -->
                <div class="multilayer-group">
                    <h4>üíì Biometric Data (Optional)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">Heart Rate (BPM)</label>
                            <input type="number" id="biometricHeartRate" placeholder="e.g., 72" min="40" max="200" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">GSR (ŒºS)</label>
                            <input type="number" id="biometricGSR" placeholder="e.g., 3.5" min="0" max="20" step="0.1" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">Temperature (¬∞F)</label>
                            <input type="number" id="biometricTemperature" placeholder="e.g., 98.6" min="90" max="105" step="0.1" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                        </div>
                    </div>
                </div>

                <!-- Contextual Inputs -->
                <div class="multilayer-group" style="margin-top: 20px;">
                    <h4>üì± Contextual Data (Optional)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">Activity Type</label>
                            <select id="activityType" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                                <option value="">None</option>
                                <option value="work">Work</option>
                                <option value="exercise">Exercise</option>
                                <option value="rest">Rest</option>
                                <option value="social">Social</option>
                                <option value="entertainment">Entertainment</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">Activity Intensity (0-1)</label>
                            <input type="number" id="activityIntensity" placeholder="e.g., 0.5" min="0" max="1" step="0.1" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">Task Intensity (0-1)</label>
                            <input type="number" id="taskIntensity" placeholder="e.g., 0.7" min="0" max="1" step="0.1" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--text-secondary);">Task Complexity (0-1)</label>
                            <input type="number" id="taskComplexity" placeholder="e.g., 0.6" min="0" max="1" step="0.1" style="padding: 8px; width: 100%; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                        </div>
                    </div>
                </div>
            </div>

            <div class="voice-cloning-section" style="margin-top: 20px; background: var(--surface); padding: 20px; border-radius: 10px;">
                <h3>üé≠ Voice Cloning</h3>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                    Upload a voice sample (15-60 seconds) to make the AI speak in that voice when you miss someone.
                </p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="voiceClonePersonName" placeholder="Person's name (e.g., Dilshika)" style="padding: 8px; width: 100%; max-width: 300px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--surface-light); color: var(--text-primary);">
                    <input type="file" id="voiceCloneFile" accept="audio/*" style="display: none;" onchange="handleVoiceCloneFile(event)">
                    <button onclick="document.getElementById('voiceCloneFile').click()" class="record-btn" style="width: fit-content;">üì§ Upload Voice Sample</button>
                </div>
                <div id="voiceCloneStatus" style="margin-top: 10px; font-size: 0.9rem; min-height: 20px;"></div>
                <div id="clonedVoicesList" class="voice-notes-list" style="margin-top: 15px;"></div>
            </div>

            <div class="results-section">
                <!-- Multi-Layer Result Container -->
                <div id="multilayerResultContainer" class="multilayer-result-container" style="display: none;"></div>

                <div id="emotionResult" class="result-card" style="display: none;">
                    <h3>Detected Emotion</h3>
                    <div class="emotion-display">
                        <span id="emotionType" class="emotion-badge"></span>
                        <span id="emotionConfidence" class="confidence"></span>
                    </div>
                </div>

                <div id="adaptiveResponse" class="result-card" style="display: none;">
                    <h3>Adaptive Response</h3>
                    <p id="responseMessage" class="response-message"></p>
                    <div id="responseSuggestion" class="suggestion"></div>
                </div>

                <div id="iotActions" class="result-card" style="display: none;">
                    <h3>IoT Device Actions <span class="simulation-badge">SIMULATION MODE</span></h3>
                    <p class="simulation-notice">‚ö†Ô∏è These actions are simulated. To control real devices, integrate with IoT platforms (Philips Hue, Spotify, etc.).</p>
                    <div id="iotActionsList" class="iot-actions-list"></div>
                </div>
            </div>

            <div class="status-section">
                <div id="connectionStatus" class="status-indicator">
                    <span class="status-dot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js?v=2.0"></script>
    <script src="facial-detection.js?v=1.0"></script>
    <script src="voice-cloning.js?v=1.0"></script>
    <script src="multilayer-emotion.js?v=1.0"></script>
    <script>
        // Initialize multi-layer emotion detection on page load
        window.addEventListener('load', function() {
            if (window.initMultiLayerEmotion) {
                initMultiLayerEmotion();
            }
        });
    </script>
</body>
</html>

